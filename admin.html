<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - Chinese Anime 3D</title>
  <meta name="theme-color" content="#7f1d1d">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
      body { background-color: #0f172a; color: #cbd5e1; }
      .hide { display: none !important; }
      .day-select-btn { background-color: #1e293b; border: 1px solid #475569; color: #94a3b8; padding: 4px 8px; border-radius: 6px; font-size: 10px; cursor: pointer; transition: all 0.2s; user-select: none; }
      .day-select-btn.selected { background-color: #2563eb; color: white; border-color: #3b82f6; box-shadow: 0 0 5px rgba(37, 99, 235, 0.5); }
      input[type="datetime-local"] { color-scheme: dark; cursor: pointer; }
      .custom-scroll::-webkit-scrollbar { width: 4px; }
      .custom-scroll::-webkit-scrollbar-thumb { background: #475569; border-radius: 2px; }
      
      /* TAB BUTTONS */
      .tab-nav-btn { flex: 1; text-align: center; padding: 10px; font-weight: bold; font-size: 12px; cursor: pointer; border-bottom: 2px solid transparent; color: #64748b; transition: all 0.2s; }
      .tab-nav-btn.active { color: #3b82f6; border-bottom-color: #3b82f6; background: rgba(59, 130, 246, 0.05); }
      .tab-nav-btn:hover { color: #cbd5e1; background: rgba(255,255,255,0.05); }
  </style>
</head>
<body class="min-h-screen flex flex-col font-sans text-sm pb-10">

  <nav class="bg-red-900/90 backdrop-blur p-3 shadow-lg sticky top-0 z-50">
      <div class="container mx-auto flex justify-between items-center px-2">
          <span class="font-bold text-white flex items-center gap-2">üîí Admin Control Panel</span>
          <div class="flex gap-2">
              <a href="/" target="_blank" class="bg-slate-800 text-gray-300 px-3 py-1 rounded text-xs hover:bg-slate-700">Buka Web</a>
              <button onclick="adminLogout()" class="bg-red-950 text-red-200 px-3 py-1 rounded border border-red-700 hover:bg-red-800 transition text-xs">Exit</button>
          </div>
      </div>
  </nav>

  <main class="container mx-auto p-4 max-w-4xl flex-grow">
      
      <!-- LOGIN VIEW -->
      <div id="view-admin-login" class="flex justify-center items-center h-[80vh]">
          <div class="bg-slate-800 p-8 rounded-xl shadow-2xl border border-slate-700 text-center w-full max-w-sm">
              <h2 class="font-bold text-2xl text-red-500 mb-6">Admin Access</h2>
              <form onsubmit="event.preventDefault(); adminLogin();">
                  <input type="text" id="admin-user" placeholder="Username" autocomplete="username" class="block w-full mb-4 p-3 bg-slate-900 rounded border border-slate-600 text-white text-sm focus:border-red-500 outline-none">
                  <input type="password" id="admin-pass" placeholder="Password" autocomplete="current-password" class="block w-full mb-6 p-3 bg-slate-900 rounded border border-slate-600 text-white text-sm focus:border-red-500 outline-none">
                  <button class="bg-red-600 px-4 py-3 rounded text-white font-bold w-full hover:bg-red-500 transition shadow-lg">MASUK</button>
              </form>
              <p id="admin-msg" class="text-xs text-red-400 mt-4 h-4"></p>
          </div>
      </div>

      <!-- PANEL DASHBOARD -->
      <div id="view-admin-panel" class="hide">
          
          <!-- TAB NAVIGATION -->
          <div class="bg-slate-800 rounded-t-lg border-x border-t border-slate-700 flex mb-0 overflow-hidden">
              <button onclick="switchTab('anime')" id="btn-tab-anime" class="tab-nav-btn active">üì∫ KELOLA ANIME</button>
              <button onclick="switchTab('chat')" id="btn-tab-chat" class="tab-nav-btn">üí¨ KELOLA CHAT</button>
              <button onclick="switchTab('users')" id="btn-tab-users" class="tab-nav-btn">üö´ BLACKLIST USER</button>
          </div>

          <!-- CONTENT CONTAINER -->
          <div class="bg-slate-800 p-4 rounded-b-lg mb-6 border border-slate-700 min-h-[500px]">

              <!-- TAB 1: ANIME (Original) -->
              <div id="tab-anime">
                  <div class="bg-slate-900 p-4 rounded-lg mb-6 border border-slate-700">
                      <h3 class="font-bold text-red-400 mb-3 text-xs uppercase tracking-wider border-b border-slate-700 pb-2">Ganti Akun Admin</h3>
                      <div class="flex flex-col sm:flex-row gap-2">
                          <input type="text" id="admin-edit-user" placeholder="Username Baru" autocomplete="new-password" class="bg-slate-800 p-2 rounded text-xs text-white border border-slate-600 flex-1">
                          <input type="password" id="admin-edit-pass" placeholder="Password Baru" autocomplete="new-password" class="bg-slate-800 p-2 rounded text-xs text-white border border-slate-600 flex-1">
                          <button onclick="updateAdminCredentials()" class="bg-red-700 text-white px-4 py-2 rounded text-xs font-bold hover:bg-red-600 transition">Simpan</button>
                      </div>
                  </div>

                  <!-- FORM INPUT DONGHUA -->
                  <div class="bg-slate-900 p-5 rounded-lg mb-6 border border-slate-700 shadow-xl">
                      <div class="flex justify-between items-center mb-4 border-b border-slate-700 pb-3">
                          <h3 class="font-bold text-blue-400 text-sm uppercase tracking-wider">Input / Edit Donghua</h3>
                          <div class="flex gap-2">
                               <button onclick="clearForm()" class="bg-gray-600 px-3 py-1.5 rounded font-bold text-white text-xs hover:bg-gray-500">Reset Form</button>
                          </div>
                      </div>
                      
                      <input type="hidden" id="edit-id">
                      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                          <div class="space-y-3">
                              <input type="text" id="inp-title" placeholder="Judul Anime" class="w-full p-2.5 bg-slate-800 rounded border border-slate-600 text-sm text-white focus:border-blue-500 outline-none">
                              <input type="text" id="inp-img" placeholder="Poster URL (https://...)" class="w-full p-2.5 bg-slate-800 rounded border border-slate-600 text-sm text-white focus:border-blue-500 outline-none">
                              <textarea id="inp-desc" placeholder="Sinopsis..." class="w-full p-2.5 bg-slate-800 rounded border border-slate-600 text-sm text-white focus:border-blue-500 outline-none" rows="3"></textarea>
                              <textarea id="inp-notify-msg" placeholder="Pesan Telegram (Opsional)..." class="w-full p-2.5 bg-slate-800 rounded border border-slate-600 text-sm text-white focus:border-blue-500 outline-none" rows="2"></textarea>
                          </div>

                          <div class="space-y-3">
                              <div class="bg-slate-800 p-3 rounded border border-slate-700">
                                  <label class="text-[10px] text-gray-400 block mb-2 uppercase font-bold">Hari Tayang</label>
                                  <div class="flex flex-wrap gap-2" id="day-selector-container">
                                      <button type="button" onclick="toggleDaySelection(this)" data-val="Senin" class="day-select-btn">Senin</button>
                                      <button type="button" onclick="toggleDaySelection(this)" data-val="Selasa" class="day-select-btn">Selasa</button>
                                      <button type="button" onclick="toggleDaySelection(this)" data-val="Rabu" class="day-select-btn">Rabu</button>
                                      <button type="button" onclick="toggleDaySelection(this)" data-val="Kamis" class="day-select-btn">Kamis</button>
                                      <button type="button" onclick="toggleDaySelection(this)" data-val="Jumat" class="day-select-btn">Jumat</button>
                                      <button type="button" onclick="toggleDaySelection(this)" data-val="Sabtu" class="day-select-btn">Sabtu</button>
                                      <button type="button" onclick="toggleDaySelection(this)" data-val="Minggu" class="day-select-btn">Minggu</button>
                                      <button type="button" onclick="toggleDaySelection(this)" data-val="Random" class="day-select-btn">Random</button>
                                  </div>
                                  <input type="hidden" id="inp-day">
                              </div>
                              <div class="bg-slate-800 p-3 rounded border border-slate-700">
                                  <label class="text-[10px] text-gray-400 block mb-2 uppercase font-bold">‚è≥ Auto Publish (Waktu Jakarta)</label>
                                  <div class="flex gap-2">
                                      <input type="datetime-local" id="inp-schedule-time" class="flex-1 p-2 bg-slate-700 rounded border border-slate-600 text-xs text-white outline-none">
                                      <button type="button" onclick="document.getElementById('inp-schedule-time').value = ''" class="bg-slate-600 hover:bg-slate-500 text-gray-300 px-3 rounded border border-slate-600 text-xs">Clear</button>
                                  </div>
                              </div>
                          </div>
                      </div>

                      <div class="bg-slate-800 p-3 rounded border border-slate-700 mb-4">
                          <div class="flex justify-between mb-2 border-b border-slate-700 pb-2">
                              <div class="flex flex-col">
                                  <span class="text-xs font-bold text-gray-300">List Episode & Server</span>
                                  <span class="text-[9px] text-gray-500">Format Multi: Nama Server | Link (1 per baris)</span>
                              </div>
                              <button type="button" onclick="addEpisodeRow()" class="bg-blue-600 hover:bg-blue-500 text-white text-xs px-3 py-1 rounded font-bold transition">+ Tambah Episode</button>
                          </div>
                          <div id="episode-container" class="max-h-80 overflow-y-auto space-y-1 pr-2 custom-scroll"></div>
                      </div>

                      <button onclick="saveDonghua()" class="w-full bg-green-600 py-3 rounded font-bold text-white text-sm hover:bg-green-500 shadow-lg shadow-green-900/20 transition">SIMPAN DATA</button>
                  </div>

                  <!-- TABEL LIST DONGHUA -->
                  <div class="overflow-hidden bg-slate-900 rounded-lg border border-slate-700 shadow-xl">
                      <table class="w-full text-left text-xs text-gray-400">
                          <thead class="bg-slate-800 text-white font-bold uppercase">
                              <tr>
                                  <th class="p-3">Cover</th>
                                  <th class="p-3">Info Donghua</th>
                                  <th class="p-3 text-right">Aksi</th>
                              </tr>
                          </thead>
                          <tbody id="admin-list" class="divide-y divide-slate-700"></tbody>
                      </table>
                  </div>
              </div>
              <!-- END TAB 1 -->

              <!-- TAB 2: LIVE CHAT MANAGEMENT -->
              <div id="tab-chat" class="hide">
                  <div class="flex justify-between items-center mb-4 border-b border-slate-700 pb-2">
                      <h3 class="font-bold text-white text-sm">üí¨ Komentar Terbaru</h3>
                      <button onclick="fetchChatAdmin()" class="bg-blue-600 text-white px-3 py-1 rounded text-xs hover:bg-blue-500">üîÑ Refresh Chat</button>
                  </div>
                  <div class="overflow-x-auto bg-slate-900 rounded-lg border border-slate-700">
                      <table class="w-full text-left text-xs text-gray-400">
                          <thead class="bg-slate-800 text-white font-bold uppercase">
                              <tr>
                                  <th class="p-3 w-32">Waktu</th>
                                  <th class="p-3 w-32">User</th>
                                  <th class="p-3">Pesan / Konteks</th>
                                  <th class="p-3 text-right w-40">Aksi</th>
                              </tr>
                          </thead>
                          <tbody id="chat-admin-list" class="divide-y divide-slate-700">
                              <tr><td colspan="4" class="p-4 text-center">Memuat data chat...</td></tr>
                          </tbody>
                      </table>
                  </div>
              </div>
              <!-- END TAB 2 -->

              <!-- TAB 3: BANNED USERS -->
              <div id="tab-users" class="hide">
                  <div class="flex justify-between items-center mb-4 border-b border-slate-700 pb-2">
                      <h3 class="font-bold text-white text-sm">üö´ Daftar User Banned</h3>
                      <button onclick="fetchBannedUsers()" class="bg-blue-600 text-white px-3 py-1 rounded text-xs hover:bg-blue-500">üîÑ Refresh List</button>
                  </div>
                  <div class="bg-slate-900 rounded-lg border border-slate-700 p-4">
                      <div class="mb-2 text-[10px] text-gray-500 italic">*List user yang tidak bisa chat.</div>
                      <ul id="banned-users-list" class="space-y-2 text-xs text-gray-300">
                           <li class="p-2 text-center text-gray-500">Memuat...</li>
                      </ul>
                  </div>
              </div>
              <!-- END TAB 3 -->

          </div>
      </div>
  </main>

  <!-- POPUP RE-AUTH -->
  <div id="reauth-modal" class="hide fixed inset-0 bg-slate-900/90 z-[70] flex items-center justify-center backdrop-blur-sm p-4">
      <div class="bg-slate-800 w-full max-w-sm rounded-xl p-6 border border-slate-700 shadow-2xl">
          <h3 class="font-bold text-white text-lg mb-2">Sesi Berakhir</h3>
          <p class="text-xs text-slate-400 mb-4">Masukkan password admin untuk lanjut.</p>
          <form onsubmit="event.preventDefault(); handleReauth();" class="space-y-3">
              <input type="password" id="reauth-pass" placeholder="Password Admin" class="w-full p-3 bg-slate-900 rounded-lg text-white border border-slate-600 text-xs">
              <p id="reauth-msg" class="text-red-400 text-xs h-4"></p>
              <div class="flex gap-2">
                  <button type="button" onclick="adminLogout()" class="flex-1 bg-slate-600 py-2.5 rounded-lg font-bold text-white text-xs hover:bg-slate-500">Logout</button>
                  <button type="submit" class="flex-1 bg-blue-600 py-2.5 rounded-lg font-bold text-white text-xs hover:bg-blue-500">Lanjutkan</button>
              </div>
          </form>
      </div>
  </div>

  <script>
      const CONFIG = { workerUrl: "https://backup3d.ruslirusli123091.workers.dev" }; 
      let appData = { donghua: [], chats: [], banned: [] };
      let onReauthSuccess = null;

      // --- HELPER FUNCTIONS ---
      async function hashString(str) { const msgBuffer = new TextEncoder().encode(str.toLowerCase()); const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer); return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join(''); }
      async function hashPass(str) { const msgBuffer = new TextEncoder().encode(str); const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer); return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join(''); }
      function getLatestEp(eps) { if (!eps || eps.length === 0) return 0; return [...eps].sort((a, b) => parseFloat(b.ep) - parseFloat(a.ep))[0].ep; }
      function timeAgo(ts) { const d=new Date(ts); return `${d.getDate()}/${d.getMonth()+1} ${d.getHours()}:${d.getMinutes()}`; }

      // --- INIT & AUTH ---
      window.onload = function() {
          if (sessionStorage.getItem('admin_session') === 'active') {
              document.getElementById('view-admin-login').classList.add('hide');
              document.getElementById('view-admin-panel').classList.remove('hide');
              fetchDataForAdmin();
          }
      };

      async function adminLogin() {
          const u = document.getElementById('admin-user').value.trim();
          const p = document.getElementById('admin-pass').value.trim();
          const msg = document.getElementById('admin-msg');
          msg.innerText = "Verifikasi...";
          
          const hashedUser = await hashString(u);
          const hashedPass = await hashPass(p);
          
          try {
              const r = await fetch(`${CONFIG.workerUrl}/api/auth`);
              const j = await r.json();
              const users = j.users || j.admin || [];
              const found = users.find(x => x.username === hashedUser && x.password === hashedPass);
              
              if (found) {
                  sessionStorage.setItem('admin_session', 'active');
                  sessionStorage.setItem('admin_secret_temp', p);
                  document.getElementById('view-admin-login').classList.add('hide');
                  document.getElementById('view-admin-panel').classList.remove('hide');
                  fetchDataForAdmin();
              } else {
                  msg.innerText = "Username / Password Salah!";
              }
          } catch (e) { msg.innerText = "Error Worker Connection"; }
      }

      function adminLogout() {
          sessionStorage.clear();
          location.reload();
      }

      // --- TAB NAVIGATION ---
      function switchTab(tabName) {
          // Hide all
          document.getElementById('tab-anime').classList.add('hide');
          document.getElementById('tab-chat').classList.add('hide');
          document.getElementById('tab-users').classList.add('hide');
          
          // Reset buttons
          document.querySelectorAll('.tab-nav-btn').forEach(b => b.classList.remove('active'));
          
          // Show selected
          document.getElementById(`tab-${tabName}`).classList.remove('hide');
          document.getElementById(`btn-tab-${tabName}`).classList.add('active');
          
          // Load data specific to tab
          if(tabName === 'chat') fetchChatAdmin();
          if(tabName === 'users') fetchBannedUsers();
      }

      // --- FETCH DATA ---
      async function fetchDataForAdmin() {
          const secretPass = sessionStorage.getItem('admin_secret_temp');
          try {
              const r = await fetch(`${CONFIG.workerUrl}/api/donghua`, { headers: { 'X-Admin-Pass': secretPass } });
              const j = await r.json();
              appData.donghua = j.donghua || [];
              renderAdminList();
          } catch(e) { alert("Gagal mengambil data donghua: " + e.message); }
      }

      async function fetchChatAdmin() {
          const t = document.getElementById('chat-admin-list');
          t.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-gray-500">Loading chat...</td></tr>';
          try {
              const r = await fetch(`${CONFIG.workerUrl}/api/chat`);
              const j = await r.json();
              appData.chats = j.comments || [];
              renderChatAdmin();
          } catch(e) { t.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-red-500">Gagal load chat</td></tr>'; }
      }

      async function fetchBannedUsers() {
          const l = document.getElementById('banned-users-list');
          l.innerHTML = '<li class="p-2 text-center text-gray-500">Loading users...</li>';
          try {
              const r = await fetch(`${CONFIG.workerUrl}/api/users`);
              const j = await r.json();
              appData.banned = j.banned_users || [];
              renderBannedUsers();
          } catch(e) { l.innerHTML = '<li class="p-2 text-center text-red-500">Gagal load user</li>'; }
      }

      // --- RENDERERS ---
      function renderAdminList() {
          const t = document.getElementById('admin-list'); 
          t.innerHTML = ""; 
          const sorted = [...appData.donghua].sort((a,b) => (b.lastUpdated||0) - (a.lastUpdated||0));
          sorted.forEach(i => { 
              const isScheduled = i.scheduledTime && i.scheduledTime > Date.now(); 
              const statusBadge = isScheduled ? '<span class="text-[9px] bg-yellow-600 text-white px-1.5 py-0.5 rounded ml-2 font-bold animate-pulse">‚è≥ SCHEDULED</span>' : ''; 
              t.innerHTML += `<tr class="border-b border-slate-700 hover:bg-slate-750 transition"><td class="p-3 w-14"><img src="${i.image}" class="w-10 h-14 bg-black object-cover rounded shadow"></td><td class="p-3 text-white"><div class="font-bold text-sm">${i.title} ${statusBadge}</div><div class="text-xs text-gray-500 mt-1">${i.episodes?.length || 0} eps ‚Ä¢ ${i.views || 0} views ‚Ä¢ ${i.day || '-'}</div></td><td class="p-3 text-right"><button onclick="editData('${i.id}')" class="bg-blue-900/50 text-blue-400 border border-blue-900 px-3 py-1 rounded text-xs mr-2 hover:bg-blue-900">EDIT</button><button onclick="deleteData('${i.id}')" class="bg-red-900/50 text-red-400 border border-red-900 px-3 py-1 rounded text-xs hover:bg-red-900">HAPUS</button></td></tr>`; 
          }); 
      }

      function renderChatAdmin() {
          const t = document.getElementById('chat-admin-list');
          t.innerHTML = "";
          const sorted = [...appData.chats].sort((a,b) => b.timestamp - a.timestamp); // Terbaru diatas
          
          if(sorted.length === 0) {
              t.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-gray-500">Tidak ada chat</td></tr>';
              return;
          }

          sorted.forEach(c => {
              // Cari judul donghua
              const dh = appData.donghua.find(x => x.id == c.donghuaId);
              const title = dh ? dh.title : "Unknown ID";
              
              t.innerHTML += `
              <tr class="border-b border-slate-800 hover:bg-slate-800 transition">
                  <td class="p-3 text-[10px] text-gray-500 whitespace-nowrap">${timeAgo(c.timestamp)}</td>
                  <td class="p-3 font-bold text-blue-400 whitespace-nowrap">${c.user}</td>
                  <td class="p-3">
                      <div class="text-white break-words">${c.text}</div>
                      <div class="text-[9px] text-gray-600 mt-1">@ ${title} - Ep ${c.ep}</div>
                  </td>
                  <td class="p-3 text-right whitespace-nowrap">
                      <button onclick="execBanUser('${c.user}')" class="bg-black text-white border border-gray-700 px-2 py-1 rounded text-[10px] hover:bg-gray-800 mr-1">üö´ BAN</button>
                      <button onclick="execDeleteChat('${c.id}')" class="bg-red-900/40 text-red-400 border border-red-900 px-2 py-1 rounded text-[10px] hover:bg-red-900">‚ùå DEL</button>
                  </td>
              </tr>
              `;
          });
      }

      function renderBannedUsers() {
          const l = document.getElementById('banned-users-list');
          l.innerHTML = "";
          if(appData.banned.length === 0) {
              l.innerHTML = '<li class="p-4 text-center text-gray-500 border border-dashed border-slate-700 rounded">Tidak ada user banned</li>';
              return;
          }
          appData.banned.forEach(u => {
              l.innerHTML += `<li class="p-3 bg-slate-900 border border-slate-700 rounded flex justify-between items-center"><span class="font-bold text-red-400">${u}</span> <span class="text-[10px] text-gray-600">Terbanned permanen</span></li>`;
          });
      }

      // --- ACTION FUNCTIONS ---
      async function execDeleteChat(chatId) {
          const secretPass = sessionStorage.getItem('admin_secret_temp');
          if(!secretPass) return showReauthPopup(() => execDeleteChat(chatId));
          if(!confirm("Hapus chat ini?")) return;

          try {
              const r = await fetch(`${CONFIG.workerUrl}/api/chat`, {
                  method: "PUT",
                  headers: { "Content-Type": "application/json", "X-Admin-Pass": secretPass },
                  body: JSON.stringify({ action: "delete", commentId: chatId })
              });
              if(r.ok) { fetchChatAdmin(); } else { alert("Gagal hapus"); }
          } catch(e) { alert("Error: " + e.message); }
      }

      async function execBanUser(username) {
          const secretPass = sessionStorage.getItem('admin_secret_temp');
          if(!secretPass) return showReauthPopup(() => execBanUser(username));
          if(!confirm(`BANNED User: ${username}?\nMereka tidak akan bisa chat lagi.`)) return;

          try {
              const r = await fetch(`${CONFIG.workerUrl}/api/users`, {
                  method: "PUT",
                  headers: { "Content-Type": "application/json", "X-Admin-Pass": secretPass },
                  body: JSON.stringify({ action: "ban", username: username })
              });
              if(r.ok) { 
                  alert(`User ${username} berhasil dibanned.`);
                  fetchChatAdmin(); // Refresh chat (opsional jika ingin lihat efeknya)
              } else { alert("Gagal ban user"); }
          } catch(e) { alert("Error: " + e.message); }
      }


      // --- (FUNGSI LAMA TAB ANIME TIDAK BERUBAH) ---
      function addEpisodeRow(n = "", u = "") { 
          const c = document.getElementById('episode-container'); 
          const d = document.createElement('div'); 
          d.className = "ep-row flex gap-2 items-start bg-slate-800 p-2 rounded border border-slate-700 mb-2"; 
          d.innerHTML = `
              <div class="flex flex-col gap-1 mt-1 mr-1">
                  <button type="button" onclick="moveEpRow(this, -1)" class="text-gray-500 hover:text-blue-400 leading-none text-[10px]">‚ñ≤</button>
                  <button type="button" onclick="moveEpRow(this, 1)" class="text-gray-500 hover:text-blue-400 leading-none text-[10px]">‚ñº</button>
              </div>
              <input value="${n}" class="w-12 bg-slate-700 border border-slate-600 text-xs p-1.5 text-center ep-num text-white rounded focus:border-blue-500 outline-none" placeholder="Ep">
              <textarea class="flex-1 bg-slate-700 border border-slate-600 text-xs p-1.5 ep-url text-white rounded focus:border-blue-500 outline-none" placeholder="Link Video" rows="2">${u}</textarea>
              <button type="button" onclick="this.parentElement.remove()" class="text-red-500 hover:text-red-400 px-2 font-bold text-lg leading-none mt-1">√ó</button>
          `; 
          c.appendChild(d); 
      }
      function moveEpRow(btn, direction) { const row = btn.closest('.ep-row'); const container = row.parentNode; if (direction === -1 && row.previousElementSibling) container.insertBefore(row, row.previousElementSibling); else if (direction === 1 && row.nextElementSibling) container.insertBefore(row.nextElementSibling, row); }
      function editData(id) { const i = appData.donghua.find(x => x.id == id); if (!i) return; document.getElementById('edit-id').value = i.id; document.getElementById('inp-title').value = i.title; document.getElementById('inp-img').value = i.image; document.getElementById('inp-desc').value = i.synopsis; document.querySelectorAll('.day-select-btn').forEach(btn => btn.classList.remove('selected')); if (i.day) i.day.split(',').forEach(d => { const btn = document.querySelector(`.day-select-btn[data-val="${d}"]`); if(btn) btn.classList.add('selected'); }); updateHiddenDayInput(); if (i.scheduledTime) { const d = new Date(i.scheduledTime); d.setMinutes(d.getMinutes() - d.getTimezoneOffset()); document.getElementById('inp-schedule-time').value = d.toISOString().slice(0, 16); } else { document.getElementById('inp-schedule-time').value = ""; } const c = document.getElementById('episode-container'); c.innerHTML = ""; (i.episodes || []).forEach(e => addEpisodeRow(e.ep, e.url)); document.getElementById('view-admin-panel').scrollIntoView({ behavior: 'smooth' }); switchTab('anime'); }
      function clearForm() { document.getElementById('edit-id').value = ""; document.getElementById('inp-title').value = ""; document.getElementById('inp-img').value = ""; document.getElementById('inp-desc').value = ""; document.getElementById('inp-notify-msg').value = ""; document.getElementById('inp-day').value = ""; document.querySelectorAll('.day-select-btn').forEach(btn => btn.classList.remove('selected')); document.getElementById('inp-schedule-time').value = ""; document.getElementById('episode-container').innerHTML = ""; }
      function toggleDaySelection(btn) { btn.classList.toggle('selected'); updateHiddenDayInput(); }
      function updateHiddenDayInput() { const selected = []; document.querySelectorAll('.day-select-btn.selected').forEach(btn => selected.push(btn.getAttribute('data-val'))); document.getElementById('inp-day').value = selected.join(','); }
      
      // REAUTH & SAVE (CORE)
      function showReauthPopup(callback) { onReauthSuccess = callback; document.getElementById('reauth-msg').innerText = ''; document.getElementById('reauth-modal').classList.remove('hide'); document.getElementById('reauth-pass').focus(); }
      function hideReauthPopup() { document.getElementById('reauth-modal').classList.add('hide'); document.getElementById('reauth-pass').value = ''; }
      async function handleReauth() { const pass = document.getElementById('reauth-pass').value; const btn = document.querySelector('#reauth-modal button[type="submit"]'); btn.disabled = true; btn.innerText = "Cek..."; try { const r = await fetch(`${CONFIG.workerUrl}/api/verify-session`, { method: 'POST', headers: { 'X-Admin-Pass': pass } }); if (r.ok) { sessionStorage.setItem('admin_secret_temp', pass); hideReauthPopup(); if (onReauthSuccess) { const cb = onReauthSuccess; onReauthSuccess = null; cb(); } } else { document.getElementById('reauth-msg').innerText = 'Password salah.'; } } catch (e) { document.getElementById('reauth-msg').innerText = 'Error jaringan.'; } btn.disabled = false; btn.innerText = "Lanjutkan"; }

      async function saveDonghua() {
          const secretPass = sessionStorage.getItem('admin_secret_temp');
          if (!secretPass) return showReauthPopup(() => saveDonghua());
          
          const id = document.getElementById('edit-id').value;
          const title = document.getElementById('inp-title').value; if(!title) return alert("Judul wajib");
          const img = document.getElementById('inp-img').value;
          const desc = document.getElementById('inp-desc').value;
          const customMsg = document.getElementById('inp-notify-msg').value;
          const day = document.getElementById('inp-day').value;
          const scheduleInput = document.getElementById('inp-schedule-time').value;
          const scheduledTime = scheduleInput ? new Date(scheduleInput).getTime() : null;
          let eps = []; document.querySelectorAll('#episode-container > div').forEach(r => { eps.push({ ep: r.querySelector('.ep-num').value, url: r.querySelector('.ep-url').value }) });
          
          const ts = Date.now(); const isNewEntry = !id; const newItemId = id || ts.toString();
          let newItem = { id: newItemId, title, image: img, synopsis: desc, day: day, scheduledTime: scheduledTime, episodes: eps, views: 0, lastUpdated: ts };
          
          const idx = appData.donghua.findIndex(x => x.id == id);
          if (idx > -1) { newItem.views = appData.donghua[idx].views || 0; appData.donghua[idx] = newItem; } else { appData.donghua.push(newItem); }

          try {
              const r = await fetch(`${CONFIG.workerUrl}/api/donghua`, { method: "PUT", headers: { "Content-Type": "application/json", "X-Admin-Pass": secretPass }, body: JSON.stringify({ donghua: appData.donghua }) });
              if (r.ok) {
                  alert("Tersimpan!");
                  if (!scheduledTime || scheduledTime <= Date.now()) { fetch(`${CONFIG.workerUrl}/api/notify`, { method: "POST", headers: { "Content-Type": "application/json", "X-Admin-Pass": secretPass }, body: JSON.stringify({ title: newItem.title, image: newItem.image, url: `https://ds.xhtml.cfd/?page=synopsis&id=${newItemId}`, status: isNewEntry ? 'new' : 'update', latestEp: getLatestEp(newItem.episodes), customMessage: customMsg }) }).catch(e => console.log("Notif error", e)); }
                  clearForm(); renderAdminList();
              } else if (r.status === 401) { showReauthPopup(() => saveDonghua()); } else { alert("Gagal menyimpan."); }
          } catch (e) { alert("Error Worker: " + e.message); }
      }

      async function deleteData(id) {
          const secretPass = sessionStorage.getItem('admin_secret_temp');
          if (!secretPass) return showReauthPopup(() => deleteData(id));
          if (!confirm("Yakin hapus? Data hilang permanen.")) return;
          const originalData = [...appData.donghua]; appData.donghua = appData.donghua.filter(x => x.id != id);
          try {
              const r = await fetch(`${CONFIG.workerUrl}/api/donghua`, { method: "PUT", headers: { "Content-Type": "application/json", "X-Admin-Pass": secretPass }, body: JSON.stringify({ donghua: appData.donghua }) });
              if (r.ok) { renderAdminList(); } else if (r.status === 401) { appData.donghua = originalData; showReauthPopup(() => deleteData(id)); } else { alert("Gagal menghapus."); appData.donghua = originalData; }
          } catch (e) { alert("Error Network"); appData.donghua = originalData; }
      }
      function downloadSitemap() { alert("Sitemap generated"); }
      async function updateAdminCredentials() { alert("Fitur update password admin"); }
  </script>
</body>
</html>
